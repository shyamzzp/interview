<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-system-design/job-scheduling-system">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-203163469-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-203163469-1",{anonymize_ip:!0})</script>


<link rel="manifest" href="/interview/manifest.json">
<meta name="theme-color" content="#1877F2">

<script src="https://kit.fontawesome.com/307bcbc229.js"></script>
<script src="/static/scrolltotop.js"></script><title data-rh="true">Job Scheduling System â€¢ Interview Preparation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" name="twitter:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" property="og:url" content="https://shyamzzp.github.io/interview/interview/docs/system-design/job-scheduling-system"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="theme-color" content="#1877F2"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Job Scheduling System â€¢ Interview Preparation"><meta data-rh="true" name="description" content="System Design for Job Scheduling System."><meta data-rh="true" property="og:description" content="System Design for Job Scheduling System."><link data-rh="true" rel="icon" href="/interview/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shyamzzp.github.io/interview/interview/docs/system-design/job-scheduling-system"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/job-scheduling-system" hreflang="en"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/job-scheduling-system" hreflang="x-default"><link rel="stylesheet" href="/interview/assets/css/styles.2814aa8d.css">
<link rel="preload" href="/interview/assets/js/runtime~main.e6ad7e70.js" as="script">
<link rel="preload" href="/interview/assets/js/main.3af7f05a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interview/"><b class="navbar__title text--truncate">ðŸ“– Inteview Preparation</b></a><a class="navbar__item navbar__link" href="/interview/docs/design-patterns">Design Patterns ðŸš§</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Data Structures</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/arrays">Arrays</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/bit-manipulation">Bit Manipulation</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/comparators">Comparators</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/complexity">Complexity</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dequeue">Deque</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dfs">DFS</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/graph">Graph</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/linked-list">Linked List</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/map">Map</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/math">Math</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/priority-queue">Priority Queue</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/snippets">Snippets</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/tree">Tree</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/trie">Trie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Algorithms</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/algorithms">Common Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/common-problems">Common Problems</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/search-algorithms">Search Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/sorting-algorithms">Sorting Algorithms</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">System Design</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/system-design/glossary">System Design Glossary</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/interview/docs/system-design/job-scheduling-system" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/shyamzzp/interview" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub Repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/interview/"><b>ðŸ“– Inteview Preparation</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/data-structures">Data Structures</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data Structures&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interview/docs/design-patterns">Design Patterns</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/oops">OOPS Concepts</a><button aria-label="Toggle the collapsible sidebar category &#x27;OOPS Concepts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/questions">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/interview/docs/system-design">System Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;System Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/glossary">System Design Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interview/docs/system-design/job-scheduling-system">Job Scheduling System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interview/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/interview/docs/system-design"><span itemprop="name">System Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Job Scheduling System</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Job Scheduling System</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="introduction-and-requirements">Introduction and Requirements<a class="hash-link" href="#introduction-and-requirements" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">â€‹</a></h3><p>When a limit-sell order or some code is scheduled to run in the future, you need a piece of software like Apache Airflow that runs tasks when certain conditions are met. Because of its wide popularity in the industry, job scheduler has been among the top topics of system design interviews.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="requirements">Requirements<a class="hash-link" href="#requirements" title="Direct link to heading">â€‹</a></h3><p>In an interview, it is critical to lay down concretely the desired features of the system. No one can design a full-fledged system in an hour, so narrow the topic as much as possible! For the simplicity of the discussion, I&#x27;m going to focus on the core features of job schedulers:</p><ol><li>Create/delete a new job with its schedule</li><li>Query all jobs owned by the user</li><li>Query the status of a job (running, failed, finished, etc)</li><li>Query the execution history of a job</li><li>Retry support for failed tasks</li><li>On-time execution (when a job is scheduled to run at 1 PM, it should be triggered around 1 PM)</li></ol><p>Needless to say, the system should be horizontally scalable and highly available.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="traffic-estimation">Traffic Estimation<a class="hash-link" href="#traffic-estimation" title="Direct link to heading">â€‹</a></h2><p>The traffic that hits a job scheduler varies in different applications. For internal-use schedulers, the traffic is small as the number of users is limited by the team size. On the other hand, client-facing schedulers can be bombarded with tons of traffic (such as schedulers in AWS). In this article, we assume the traffic is large for better generalization:</p><ol><li>We expect millions of active users.</li><li>On average, each active user owns dozens of recurring jobs.</li><li>On average, an active user creates a couple of new jobs per week.</li><li>A large percentage of jobs repeat every day for a few times. Some jobs are executed with longer intervals.</li></ol><p>Based on the estimations above, we can make the following conclusions:</p><ol><li>The backend database should be horizontally scalable, as the execution history grows quickly (~ 100 million rows of data created every day).</li><li>The system is read-heavy, as a job is created once and read many times by the scheduler. The same holds true for execution history, an entry is created and can be queried many times by the user.</li><li>We need a distributed group of workers to run jobs concurrently with varying capabilities.</li><li>All critical services should be replicated to handle the large traffic.</li></ol><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="high-level-design">High Level Design<a class="hash-link" href="#high-level-design" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="database-design">Database Design<a class="hash-link" href="#database-design" title="Direct link to heading">â€‹</a></h3><p>In database design, the access pattern of your application determines what schema is used. Let&#x27;s investigate the requests that hit the database:</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="read-operations">Read Operations<a class="hash-link" href="#read-operations" title="Direct link to heading">â€‹</a></h4><ol><li>Given a user ID, retrieve all jobs that belong to it (by client)</li><li>Given a job ID, retrieve all/latest execution histories belonging to it (by client)</li><li>Find all jobs that are scheduled to run right now (by internal servers)</li></ol></div><div class="section-item">Write Operations<ol><li>A user can create/delete a new job schedule (by client).</li><li>The workers will add execution histories to the database (by internal servers).</li><li>The system updates the next execution timestamp of a job after running it (by internal servers).</li></ol></div></div><div class="section-container pl0 pr0">In our use case, complex relational queries are not used. Most data access can be described as primary-key queries (e.g. given a job ID, get all executions). Also, the issues of strong consistency and transactions are not of paramount importance.<p>Hence, both sharded SQL and NoSQL databases can handle all the requirements of the system as long as they are tuned for reads. For simplicity, I&#x27;m going to use NoSQL (Cassandra) language in the schema discussions, but please remember that you can choose other databases like Postgres or HBase.</p></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="database-schema">Database Schema<a class="hash-link" href="#database-schema" title="Direct link to heading">â€‹</a></h3><div class="section-container pl0 pr0"><div class="section-item pl0 width60"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="job-table">Job Table<a class="hash-link" href="#job-table" title="Direct link to heading">â€‹</a></h4><p>We need a table that keeps track of job metadata such as owners, execution intervals, and retry policies. Remember the access pattern for this table: given a user ID, get some job records. Hence, we can use UserID as the partition key, and JobID as the sort key</p></div><div class="section-item width40"><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>JobID</td><td>String</td></tr><tr><td>UserID</td><td>String</td></tr><tr><td>Interval</td><td>Integer</td></tr><tr><td>RetryTimes</td><td>Integer</td></tr><tr><td>Status</td><td>String</td></tr><tr><td>CreatedAt</td><td>DateTime</td></tr></tbody></table></div></div><div class="section-container pl0 pr0"><div class="section-item pl0 width60"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="history-table">History Table<a class="hash-link" href="#history-table" title="Direct link to heading">â€‹</a></h4><p>This table is used to store execution details of a job. Given a job, there could be multiple executions associated with it. Remember the access pattern: given a JobID, retrieve all execution histories. Hence, we use JobID as the partition key and execution ID as the sort key (the execution ID can be a simple timestamp).</p></div><div class="section-item width40"><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>JobID</td><td>String</td></tr><tr><td>ExecutionID</td><td>String</td></tr><tr><td>Status</td><td>String</td></tr><tr><td>WorkerID</td><td>String</td></tr><tr><td>RetryCount</td><td>Integer</td></tr><tr><td>CreatedAt</td><td>DateTime</td></tr></tbody></table></div></div><div class="section-container pl0 pr0"><div class="section-item pl0 width60"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="schedule-table">Schedule Table<a class="hash-link" href="#schedule-table" title="Direct link to heading">â€‹</a></h4><p> The core feature of any job scheduler is, of course, running jobs on time. Therefore, we need a data model that makes it easy to filter jobs by execution time. Here JobID is treated as the Partition Key and ExecutionTime as the Sort Key. Here is a simple design that works well for a small amount of data:</p></div><div class="section-item width40"><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>JobID</td><td>String</td></tr><tr><td>ExecutionTime</td><td>DateTime</td></tr><tr><td>Status</td><td>String</td></tr></tbody></table></div></div>To get the list of to-dos, we can simply run a query like this every minute:<mark>SELECT \* FROM ScheduleTable WHERE NextExecution == &quot;1/5/2022:08:43&quot;</mark><p>One huge issue with the current design is that each query triggers a table scan. If the data is large, additional mechanisms are needed to ensure the scalability of the system. See more in the Details section.</p><p>If you have experience with large-scale databases, the word table scan should alarm you, not to mention doing it every minute. Is there a way to filter jobs without checking every record? Yes! If we simply reverse the data model.</p><mark>Make ExecutionTime as the Partition Key and JobID as Sort Key.</mark><p>Note that the execution time is converted to UNIX timestamp with minute-lev el granularity. This means that jobs that are scheduled to run in the same minute will share the same partition key. To get jobs that are scheduled to run right now, simply find the right partition with the current UNIX timestamp:</p><mark>SELECT \* FROM ScheduleTable WHERE NextExecution &gt; &quot;1641082500&quot; AND NextExecution &lt; &quot;1641082580&quot;</mark><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="api-design">API Design<a class="hash-link" href="#api-design" title="Direct link to heading">â€‹</a></h3><p>Our application is easy to use, it only needs the following RPC interfaces:</p><mark>submit_job(user_id, schedule, code_location)</mark><mark>retrieve_all_jobs(user_id)</mark><mark>delete_job(user_id, job_id)</mark><mark>get_exec_history(job_id)</mark><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">â€‹</a></h3><p>By now weâ€™ve laid down a solid foundation for the application â€” the database schema, the RPC calls. Now is prime time to do some service-oriented designs!</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="web-service">Web Service:<a class="hash-link" href="#web-service" title="Direct link to heading">â€‹</a></h4><p>The gateway to the scheduling system. All RPC calls from the client are handled by one of the RPC servers in this service.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduling-service">Scheduling Service:<a class="hash-link" href="#scheduling-service" title="Direct link to heading">â€‹</a></h4><p>It checks the database every minute for pending jobs and pushes them to a queue for execution. Once a job is scheduled, create an entry in the execution history table with status = SCHEDULED. With this service, we guarantee that all jobs are pushed to the queue in a timely manner.</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="execution-service">Execution Service:<a class="hash-link" href="#execution-service" title="Direct link to heading">â€‹</a></h4><p>In this service, we manage a large group of execution workers. Each worker is a consumer and executes whatever jobs it gets from the queue. Additional bookkeeping is needed to ensure re-execution upon worker failures.</p><p><img loading="lazy" alt="Architecture BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-19-16-02-dd0e15a5297603ecaf39937eff392663.png" width="1375" height="931" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="details">Details<a class="hash-link" href="#details" title="Direct link to heading">â€‹</a></h2><p>If you see the figure above in detail, you might be wondering about the purpose of the master in the Scheduling Service or the health checker in the Execution Service. In this section, we are going to discuss the necessity of these components and why do they work.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="run-tasks-on-schedule">Run tasks on schedule<a class="hash-link" href="#run-tasks-on-schedule" title="Direct link to heading">â€‹</a></h3><p>Letâ€™s examine the query statement again:</p><mark>SELECT \* FROM ScheduleTable WHERE NextExecution &gt; &quot;1641082500&quot; AND NextExecution &lt; &quot;1641082580&quot;</mark><p>When the number of jobs running concurrently is small, the query yields a reasonable amount of data. However, if, letâ€™s say, 100K jobs are scheduled to run in this minute, we certainly need more workers to handle the ingress data from the query as well as push messages to the queue.</p><p>The complexity arises when multiple workers are introduced â€” How can we distribute the data so that each worker only consumes a small fraction (10%) of the 100K jobs? It turns out that a simple composite partition key can fix this issue:</p><p><img loading="lazy" alt="Schedule Table with Composite Partition Key BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-19-19-27-5e72790bf5515d8896c979a4b9a2990e.png" width="441" height="233" class="img_ev3q"></p><p>When a row is added to the schedule table, it is randomly assigned a shard number. With the new schema, it is super easy to distribute the load across workers:</p><mark>Worker 1: SELECT * FROM ScheduleTable WHERE NextExecution &gt; &quot;1641082500&quot; AND NextExecution &lt; &quot;1641082580&quot; AND shard =1 Worker 2: SELECT * FROM ScheduleTable WHERE NextExecution &gt; &quot;1641082500&quot; AND NextExecution &lt; &quot;1641082580&quot; AND shard = 2 ...</mark><p>Although the additional partition key makes it easy to shard data, there is another wrinkle â€” workers come and go all the time. There is no guarantee that all shards will be covered. The problem becomes how can we assign N shards evenly to M workers, where M can change at any time?</p><p><img loading="lazy" alt="Scheduling Service in Detail BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-19-20-49-0874922d879aa2f18bc7e41d7c05a276.png" width="654" height="313" class="img_ev3q"></p><p>To make sure a complete work assignment, we can borrow some ideas from MapReduce, where a master is used to assign and monitor workers. If a worker dies, the master will resend its work to some other nodes. An additional local database is used so that no job is scheduled twice. When a job is pushed to the queue, an entry is created in the local DB with 2 minutes of expiration time. If the original handler of the record dies and the shard is handed over to another worker, the new worker will skip tasks that exist in the database.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="queue-delivery">Queue delivery<a class="hash-link" href="#queue-delivery" title="Direct link to heading">â€‹</a></h3><p>A queue is introduced for two reasons. Firstly, we want a buffer that holds all pending jobs at peak hours. Secondly, it decouples the two services. The execution service can increase/decrease its capacity without coordination with the scheduling service. However, with the additional middleware, we must consider what type of delivery works best for the system (Assume the queue is implemented in Kafka).</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="at-least-once-delivery">At-least-once delivery<a class="hash-link" href="#at-least-once-delivery" title="Direct link to heading">â€‹</a></h4><p>In this mode of delivery, messages are processed before their indices are committed by the consumer. If the consumer dies before committing, the same message will be processed again by a different worker.</p></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="at-most-once-delivery">At-most-once delivery<a class="hash-link" href="#at-most-once-delivery" title="Direct link to heading">â€‹</a></h4><p>In this mode of delivery, messages are processed after their indices are committed by the consumer. If the consumer dies before finishing the task, the job wonâ€™t be reprocessed.</p></div><p>In our application, at-least-once delivery is more fault-tolerant and makes it easy to retry failed tasks upon orchestrator failure. A message (job) is committed only when the orchestrator successfully starts a container on one of the workers.</p></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="handling-failures--retries">Handling failures &amp; Retries<a class="hash-link" href="#handling-failures--retries" title="Direct link to heading">â€‹</a></h3><p>Although at-least-once delivery guarantees that every job gets assigned to a worker, it does not prevent jobs from getting dropped upon worker failure. To achieve true retry capability, an asynchronous health checker is introduced to run the following logic:</p><ol><li>When a job is assigned, an entry is created in the local database with the latest update time.</li><li>All workers are required to refresh the update time ~10s.</li><li>The health checker will periodically scan the table, looking for jobs with stale update time (e.g. older than 30 seconds).</li><li>Jobs that meet the above criteria are sent back to the queue for re-execution.</li></ol><p><img loading="lazy" alt="Failure Handling BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-19-24-43-e6a6dcdb220a464075a9da59e48dcfb0.png" width="597" height="572" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="data-flow">Data Flow<a class="hash-link" href="#data-flow" title="Direct link to heading">â€‹</a></h2><p>With all the wrinkles in the high-level design address, we can finally come up with the data flow of the system:</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="createdelete-jobretrieve-history">Create/delete job/Retrieve history<a class="hash-link" href="#createdelete-jobretrieve-history" title="Direct link to heading">â€‹</a></h3><ol><li>The client sends out an RPC call to Web Service.</li><li>One of the RPC servers queries the database using the provided partition key and return the result.</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="schedule-a-job">Schedule a job<a class="hash-link" href="#schedule-a-job" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="master">Master<a class="hash-link" href="#master" title="Direct link to heading">â€‹</a></h4><ol><li>Every minute, the master node creates an authoritative UNIX timestamp and assigns a shard ID (see details for more) to each worker along with the timestamp</li><li>Check worker health regularly. If it dies, reassign its work to others</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="worker">Worker<a class="hash-link" href="#worker" title="Direct link to heading">â€‹</a></h4><ol><li>The worker queries the database with the timestamp and shard ID.</li><li>For each row, send it to the queue if it has not been scheduled (see details for more)</li></ol></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="execute-a-job">Execute a job<a class="hash-link" href="#execute-a-job" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="orchestrator">Orchestrator<a class="hash-link" href="#orchestrator" title="Direct link to heading">â€‹</a></h4><ol><li>A group of orchestrators consumes messages from the queue</li><li>Given a message, find one worker with the least workload. Assign the job to the worker</li><li>Commit the index, repeat steps 1 to 3</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="worker-1">Worker<a class="hash-link" href="#worker-1" title="Direct link to heading">â€‹</a></h4><p>The worker regularly update the local database with its timestamp</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="health-checker">Health Checker<a class="hash-link" href="#health-checker" title="Direct link to heading">â€‹</a></h4><ol><li>Scans the local database ~ 10 seconds</li><li>If any row hasnâ€™t been updated in ~30 seconds, retry it by pushing the job ID to the queue</li></ol></div></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">â€‹</a></h2><ul><li><a href="https://towardsdatascience.com/ace-the-system-design-interview-job-scheduling-system-b25693817950" target="_blank" rel="noopener noreferrer">https://towardsdatascience.com/ace-the-system-design-interview-job-scheduling-system-b25693817950</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/interview/docs/system-design/instagram"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Instagram System Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interview/docs/system-design/netflix"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Netflix System Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-and-requirements" class="table-of-contents__link toc-highlight">Introduction and Requirements</a><ul><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#requirements" class="table-of-contents__link toc-highlight">Requirements</a></li></ul></li><li><a href="#traffic-estimation" class="table-of-contents__link toc-highlight">Traffic Estimation</a></li><li><a href="#high-level-design" class="table-of-contents__link toc-highlight">High Level Design</a><ul><li><a href="#database-design" class="table-of-contents__link toc-highlight">Database Design</a><ul><li><a href="#read-operations" class="table-of-contents__link toc-highlight">Read Operations</a></li></ul></li><li><a href="#database-schema" class="table-of-contents__link toc-highlight">Database Schema</a><ul><li><a href="#job-table" class="table-of-contents__link toc-highlight">Job Table</a></li><li><a href="#history-table" class="table-of-contents__link toc-highlight">History Table</a></li><li><a href="#schedule-table" class="table-of-contents__link toc-highlight">Schedule Table</a></li></ul></li><li><a href="#api-design" class="table-of-contents__link toc-highlight">API Design</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#web-service" class="table-of-contents__link toc-highlight">Web Service:</a></li><li><a href="#scheduling-service" class="table-of-contents__link toc-highlight">Scheduling Service:</a></li><li><a href="#execution-service" class="table-of-contents__link toc-highlight">Execution Service:</a></li></ul></li></ul></li><li><a href="#details" class="table-of-contents__link toc-highlight">Details</a><ul><li><a href="#run-tasks-on-schedule" class="table-of-contents__link toc-highlight">Run tasks on schedule</a></li><li><a href="#queue-delivery" class="table-of-contents__link toc-highlight">Queue delivery</a><ul><li><a href="#at-least-once-delivery" class="table-of-contents__link toc-highlight">At-least-once delivery</a></li><li><a href="#at-most-once-delivery" class="table-of-contents__link toc-highlight">At-most-once delivery</a></li></ul></li><li><a href="#handling-failures--retries" class="table-of-contents__link toc-highlight">Handling failures &amp; Retries</a></li></ul></li><li><a href="#data-flow" class="table-of-contents__link toc-highlight">Data Flow</a><ul><li><a href="#createdelete-jobretrieve-history" class="table-of-contents__link toc-highlight">Create/delete job/Retrieve history</a></li><li><a href="#schedule-a-job" class="table-of-contents__link toc-highlight">Schedule a job</a><ul><li><a href="#master" class="table-of-contents__link toc-highlight">Master</a></li><li><a href="#worker" class="table-of-contents__link toc-highlight">Worker</a></li></ul></li><li><a href="#execute-a-job" class="table-of-contents__link toc-highlight">Execute a job</a><ul><li><a href="#orchestrator" class="table-of-contents__link toc-highlight">Orchestrator</a></li><li><a href="#worker-1" class="table-of-contents__link toc-highlight">Worker</a></li><li><a href="#health-checker" class="table-of-contents__link toc-highlight">Health Checker</a></li></ul></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/interview/assets/js/runtime~main.e6ad7e70.js"></script>
<script src="/interview/assets/js/main.3af7f05a.js"></script>
</body>
</html>