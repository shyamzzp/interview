<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-system-design/uber">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-203163469-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-203163469-1",{anonymize_ip:!0})</script>


<link rel="manifest" href="/interview/manifest.json">
<meta name="theme-color" content="#1877F2">

<script src="https://kit.fontawesome.com/307bcbc229.js"></script>
<script src="https://unpkg.com/driver.js/dist/driver.min.js"></script>
<script src="https://unpkg.com/driver.js/dist/driver.min.css"></script>
<script src="/static/scrolltotop.js"></script><title data-rh="true">Uber/Lyft System Design ‚Ä¢ Interview Preparation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" name="twitter:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" property="og:url" content="https://shyamzzp.github.io/interview/interview/docs/system-design/uber"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="theme-color" content="#1877F2"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Uber/Lyft System Design ‚Ä¢ Interview Preparation"><meta data-rh="true" name="description" content="System Design for Uber/Lyft."><meta data-rh="true" property="og:description" content="System Design for Uber/Lyft."><link data-rh="true" rel="icon" href="/interview/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shyamzzp.github.io/interview/interview/docs/system-design/uber"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/uber" hreflang="en"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/uber" hreflang="x-default"><link rel="stylesheet" href="/interview/assets/css/styles.a64e7799.css">
<link rel="preload" href="/interview/assets/js/runtime~main.245c4bb3.js" as="script">
<link rel="preload" href="/interview/assets/js/main.4520b17d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interview/"><b class="navbar__title text--truncate">üìñ Inteview Preparation</b></a><a class="navbar__item navbar__link" href="/interview/docs/design-patterns">Design Patterns üöß</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Data Structures</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/arrays">Arrays</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/bit-manipulation">Bit Manipulation</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/comparators">Comparators</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/complexity">Complexity</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dequeue">Deque</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dfs">DFS</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/graph">Graph</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/linked-list">Linked List</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/map">Map</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/set">Set</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/matrix">Matrix</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/math">Math</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/priority-queue">Priority Queue</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/tree">Tree</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/trie">Trie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Algorithms</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/algorithms">Common Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/common-problems">Common Problems</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/search-algorithms">Search Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/sorting-algorithms">Sorting Algorithms</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">System Design</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Glossary</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/ds-glossary">Data Structures Glossary</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/glossary">System Design Glossary</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Practice Sets</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/problem-set/geeksforgeeks/microsoft/set-1">GeeksForGeeks - Microsoft (Set-1)</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/interview/docs/system-design/uber" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/shyamzzp/interview" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub Repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/interview/"><b>üìñ Inteview Preparation</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/data-structures">Data Structures</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data Structures&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interview/docs/design-patterns">Design Patterns</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/oops">OOPS Concepts</a><button aria-label="Toggle the collapsible sidebar category &#x27;OOPS Concepts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/interview/docs/problem-set/geeksforgeeks/microsoft/set-1">problem-set</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/questions">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/interview/docs/system-design">System Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;System Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/glossary">System Design Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/job-scheduling-system">Job Scheduling System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interview/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/interview/docs/system-design"><span itemprop="name">System Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Uber/Lyft System Design</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Uber/Lyft System Design</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="introduction--requirements-of-the-system">Introduction &amp; Requirements of the System<a class="hash-link" href="#introduction--requirements-of-the-system" title="Direct link to heading">‚Äã</a></h2><p>When it comes to getting about in cities, many people choose ride-sharing apps like Uber or Lyft. Indeed, such apps make short-range commute very easy by offering competitive pricing, reasonably short wait time, and high availability. From a technical point of view, systems like these are very interesting because nearest-neighbor searching is hard. In this article, I want to share my design of large-scale ride-sharing apps like Uber/Lyft.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="functional-requirements">Functional Requirements<a class="hash-link" href="#functional-requirements" title="Direct link to heading">‚Äã</a></h3><p>Modern ride-sharing apps offer complex features such as carpooling, trip sharing, real-time chat in addition to ride-matching. In this article, I want to keep the discussion brief and focus only on the core functionality ‚Äî booking a ride. Below are the functional requirements of our system:</p><ul><li>Users can request a ride and should be matched to a driver in close proximity</li><li>Users can see all nearby drivers (although not choosing which one)</li><li>Drivers can answer/decline requests from nearby riders.</li><li>When a trip is created, both parties see each other&#x27;s real-time location.</li></ul><p>Needless to say, the system should be scalable and highly available.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="traffic-estimation">Traffic Estimation<a class="hash-link" href="#traffic-estimation" title="Direct link to heading">‚Äã</a></h3><p>Before talking about traffics, let&#x27;s examine a unique feature of Uber ‚Äî its data usage is local. Unlike apps such as Slack or Instagram, inter-region data communication is rarely needed. If you are physically in New York, you can&#x27;t book a ride in London. Hence, locational data and trips are not replicated across different regions (less-frequently accessed data such as profiles are replicated globally, of course). In this sense, discussing global traffic is not as meaningful as <mark>Regional traffic</mark>.</p><p>The amount of ride requests hitting our system varies depending on the app&#x27;s popularity. Here we assume significant regional traffic for a generalized solution:</p><ul><li>Group cities by proximity into regions. We need maybe a dozen regions to cover the whole of U.S</li><li>We expect ~100K active drivers in one region.</li><li>We expect ~1M active users in one region.</li><li>The total amount of users globally is 10M.</li></ul><p>Assume both drivers and riders emit their location ~5s with each message consisting of longitude, latitude, and additional metadata. In addition, riders regularly check nearby drivers (~5s) and sometimes make a ride request. The amount of QPS and bandwidth we can expect are:</p><ul><li>We expect ~200K location updates/writes per second</li><li>We expect ~200K queries per second, double it for peak traffic handling.</li><li>Each location message consists of ID (8 bytes), longitude and latitude (16 bytes), and other info (64 bytes). The total upload bandwidth is just shy of 88MB/s</li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="high-level-design">High-level Design<a class="hash-link" href="#high-level-design" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="database-design">Database Design<a class="hash-link" href="#database-design" title="Direct link to heading">‚Äã</a></h3><p>The access pattern of our application determines what schema is used. Let&#x27;s investigate the requests that hit the database:</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="read-operations">Read Operations<a class="hash-link" href="#read-operations" title="Direct link to heading">‚Äã</a></h4><ul><li>Given a user ID, retrieve its profile</li><li>Given a user ID, retrieve all trips completed by the user</li><li>Given longitude and latitude, query all drivers nearby</li></ul></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="write-operations">Write Operations<a class="hash-link" href="#write-operations" title="Direct link to heading">‚Äã</a></h4><ul><li>Given a user ID, update its location</li><li>Given a trip ID, the driver can either take/decline the request</li></ul></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="database-schema">Database Schema<a class="hash-link" href="#database-schema" title="Direct link to heading">‚Äã</a></h3><p>Given the access patterns, sharded SQL is a good choice since no complex relationship queries are made. Note that NoSQL databases like Cassandra could also be used here if strong consistency is not a hard requirement.</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="driver-profile-table">Driver Profile Table<a class="hash-link" href="#driver-profile-table" title="Direct link to heading">‚Äã</a></h4><table><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody><tr><td>Driver ID (primary key)</td><td>String</td></tr><tr><td>Driver Name</td><td>String</td></tr><tr><td>Profile Picture URL</td><td>String</td></tr><tr><td>License Plate Number</td><td>String</td></tr><tr><td>Car Make and Model</td><td>String</td></tr><tr><td>Rating</td><td>Double</td></tr><tr><td>Longitude</td><td>Double</td></tr><tr><td>Latitude</td><td>Double</td></tr><tr><td>Last updated timestamp</td><td>Timestamp</td></tr></tbody></table></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rider-profile-table">Rider Profile Table<a class="hash-link" href="#rider-profile-table" title="Direct link to heading">‚Äã</a></h4><table><thead><tr><th>Column Name</th><th>Type</th></tr></thead><tbody><tr><td>User ID (primary key)</td><td>String</td></tr><tr><td>User Name</td><td>String</td></tr><tr><td>Profile Picture URL</td><td>String</td></tr><tr><td>Longitude</td><td>Double</td></tr><tr><td>Latitude</td><td>Double</td></tr><tr><td>Last updated timestamp</td><td>Timestamp</td></tr></tbody></table></div></div><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="trip-details-table">Trip Details Table<a class="hash-link" href="#trip-details-table" title="Direct link to heading">‚Äã</a></h4><table><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody><tr><td>Trip ID (primary key)</td><td>String</td></tr><tr><td>Driver ID</td><td>String</td></tr><tr><td>Rider ID</td><td>String</td></tr><tr><td>Location Stamps</td><td>List</td></tr><tr><td>Status</td><td>String</td></tr></tbody></table></div><div class="section-item">In addition to these database tables, we need another high-performance storage to hold frequently-updated location data. Since live location data is inherently ephemeral, persisting them onto disks does not make sense.<p>A good alternative would be using an in-memory cache such as Redis or Memcache.</p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cache-schema">Cache Schema<a class="hash-link" href="#cache-schema" title="Direct link to heading">‚Äã</a></h3><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="location-truth-cache">Location Truth Cache<a class="hash-link" href="#location-truth-cache" title="Direct link to heading">‚Äã</a></h4><ul><li>User ID (primary key)</li><li>Longitude</li><li>User Type</li><li>Expiration Timestamp</li></ul><p>This cache is the source of truth when it comes to user location. Phone apps send regular updates to maintain accuracy. If a user gets disconnected, its record expires in 30 seconds.</p></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="driver-proximity-cache">Driver proximity Cache<a class="hash-link" href="#driver-proximity-cache" title="Direct link to heading">‚Äã</a></h4><ul><li>geohash (primary key)</li><li>drivers (sorted set)</li></ul><p>The proximity cache is crucial for nearby driver search. Given a location, we can use GeoHash to compute its location key and retrieve all drivers in the grid. I&#x27;ll talk more about this in the Details section.</p></div></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">‚Äã</a></h2><p>With a clearer understanding of what data to store, now it&#x27;s time for service-oriented designs!</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="notification-service">Notification Service<a class="hash-link" href="#notification-service" title="Direct link to heading">‚Äã</a></h3><p>Whenever the backend needs to send information to the clients, the notification service is used to deliver the messages.</p></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="trip-management-service">Trip Management Service<a class="hash-link" href="#trip-management-service" title="Direct link to heading">‚Äã</a></h4><p>When a trip is initiated, this service is needed to monitor the locations of all parties as well as plan routes</p></div></div><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ride-matching-service">Ride Matching Service<a class="hash-link" href="#ride-matching-service" title="Direct link to heading">‚Äã</a></h4><p>This service handles ride requests. It finds nearby drivers and matchmakes based on driver responses (either accept or decline)</p></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="location-service">Location Service<a class="hash-link" href="#location-service" title="Direct link to heading">‚Äã</a></h4><p>All users must regularly update their locations via this service.</p></div></div><p><img loading="lazy" alt="Architecture BorderRadius8 MarginTop10##" src="/interview/assets/images/2022-06-25-15-29-30-c43b8f44e16600dc759496e809aebf55.png" width="1384" height="905" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="workflow">Workflow<a class="hash-link" href="#workflow" title="Direct link to heading">‚Äã</a></h2><div class="section-container pl0 pr0"><div class="section-item pl0"><ol><li>Bob sends a ride request to the Ride Matching service and hopes to pair with a driver.</li><li>The Rider Matching service contacts the Location service and finds all available drivers in the same region.</li><li>The Rider Matching service then conducts ranking/filtering and pushes the ride request to selected drivers via the Notification service.</li></ol></div><div class="section-item"><ol start="4"><li>Drivers can accept/decline the request. When received, the Ride Matching Service will send the trip details to the Trip Management service.</li><li>The Trip Management service monitors the trip progress and broadcasts driver&amp;rider locations to all parties involved in the trip.</li></ol></div></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="high-level-architecture---deep-dive">High Level Architecture - Deep Dive<a class="hash-link" href="#high-level-architecture---deep-dive" title="Direct link to heading">‚Äã</a></h2><p>In this section we will look into the location based problems that are faced by our application.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-to-efficiently-look-up-nearby-drivers">How to efficiently look up nearby drivers?<a class="hash-link" href="#how-to-efficiently-look-up-nearby-drivers" title="Direct link to heading">‚Äã</a></h3><div class="section-container pl0 pr0"><div class="section-item pl0">Nearest neighbor search is a hard problem and the scale of our system makes efficient lookup even more difficult. Instead of computing the distance between the rider and every driver in the database, we can use a technique called GeoHash to convert the user&#x27;s location to a unique key that corresponds to one cell</div><div class="section-item">Therefore, we can use the following heuristic to quickly lookup drivers:<ol><li>Given a user location, compute its GeoHash from longitude and latitude.</li><li>With the GeoHash key available, it&#x27;s easy to compute the keys for the 8 nearby cells. (see this post)</li><li>Query the Location service with all 9 keys; retrieve drivers in those cells.</li></ol><p>The accuracy of GeoHash is determined by the key length. The longer the key is, the smaller each cell would be.</p></div></div><div class="section-container pl0 pr0"><div class="section-item pl0">What would be a good key size to use? In practice, the key size is determined iteratively based on the number of drivers and riders. In my opinion, a good starting point would be size 6, as it covers a few city blocks.</div><div class="section-item">There are physical limitations for the maximum number of drivers and riders that can fit in one of these cells. Each cell will be an entry in the Driver Proximity cache in Redis.</div>You might be wondering if Redis can handle this level of traffic. If there are 1M active riders in the region, the number of requests hitting the cluster is around 200K writes/s (each user updates its location ~5s) and 2M reads/s (each user reads 9 Redis keys ~5s). With even one single AWS c5.18xlarge node with 32 threads, the system can handle the traffic. In practice, we can distribute the workload to dozens of computers and achieve ~100M level RPS capacity.<p>What about memory limitations? If we use size 6 geohash, there are potentially 32‚Å∂ ~=10 billion keys in the cache, which is crazy. However, we will never reach this amount of keys if empty keys are removed (figure 5). In practice, the number of cache entries is constrained by the number of cars because each car can only be in one cell! Hence, memory is not the bottleneck.</p></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="location-update">Location update<a class="hash-link" href="#location-update" title="Direct link to heading">‚Äã</a></h3><div class="section-container pl0 pr0"><div class="section-item pl0">Hopefully I&#x27;ve convinced you of the viability of hosting the Location service on Redis. Now let&#x27;s examine how users update their locations.<p>There are two tables in the cache ‚Äî the location truth table and the driver proximity table. The usage of the location truth table is simple. The user&#x27;s mobile app sends out its location as well as the user ID to the Location service every 5 seconds. </p><p>Whenever a user&#x27;s accurate location is needed, the system can query this table by user ID.</p></div><div class="section-item">The proximity table is more interesting in nature. Drivers move around in their cars, which means they often cross one cell to the other. When the backend receives updates from a driver, it doesn&#x27;t know what cells they have been in the past.<p>Hence, it is hard to remove drivers from their old cells. The implication is obvious; the same driver can appear in multiple cells because of the stale data.</p></div></div><p><img loading="lazy" alt="Stale Data Handling BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-15-41-05-b3e33b01d3e4140cb0fe744bcaae38ae.png" width="584" height="329" class="img_ev3q"></p><p>To deal with this problem, we could introduce a timestamp to each record. With timestamps, it is easy to filter out stale location data. In practice, the sorted set data structure in Redis is an efficient way to achieve such a feature.</p><p>In addition to the driver&#x27;s location, we can keep information such as vehicle type, trip status (free, in ride) in the cache. With the additional information, ride-matching can be made quickly since the round trip to the database (query vehicle information and trip status) is skipped.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="trip-recoding">Trip recoding<a class="hash-link" href="#trip-recoding" title="Direct link to heading">‚Äã</a></h3><p>Another important feature of our system is trip recording. For a completed trip, we want to store the route that was taken by the driver and make it available to the client for review.</p><p>There are many ways to achieve this feature; the simplest way would be relying on the drivers to report their location as well as their trip status. The Location service will batch write all location updates with in-trip status to the database for persistent storage.</p><p>Relying on the client app is risky. What if the client app loses all local data while on a trip? It will not know the driver&#x27;s status before the reboot. To recover from failure, the client app should check if there&#x27;s any unfinished trip in the database and confirm their status with the driver.</p><p><img loading="lazy" alt="failure recovery BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-15-42-07-9db58158b68e4e9fc130f6f70ca14a84.png" width="659" height="247" class="img_ev3q"></p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">‚Äã</a></h2><ul><li><a href="https://towardsdatascience.com/ace-the-system-design-interview-uber-lyft-7e4c212734b3" target="_blank" rel="noopener noreferrer">https://towardsdatascience.com/ace-the-system-design-interview-uber-lyft-7e4c212734b3</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/interview/docs/system-design/twitter-system-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Twitter System Design</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction--requirements-of-the-system" class="table-of-contents__link toc-highlight">Introduction &amp; Requirements of the System</a><ul><li><a href="#functional-requirements" class="table-of-contents__link toc-highlight">Functional Requirements</a></li><li><a href="#traffic-estimation" class="table-of-contents__link toc-highlight">Traffic Estimation</a></li></ul></li><li><a href="#high-level-design" class="table-of-contents__link toc-highlight">High-level Design</a><ul><li><a href="#database-design" class="table-of-contents__link toc-highlight">Database Design</a><ul><li><a href="#read-operations" class="table-of-contents__link toc-highlight">Read Operations</a></li><li><a href="#write-operations" class="table-of-contents__link toc-highlight">Write Operations</a></li></ul></li><li><a href="#database-schema" class="table-of-contents__link toc-highlight">Database Schema</a><ul><li><a href="#driver-profile-table" class="table-of-contents__link toc-highlight">Driver Profile Table</a></li><li><a href="#rider-profile-table" class="table-of-contents__link toc-highlight">Rider Profile Table</a></li><li><a href="#trip-details-table" class="table-of-contents__link toc-highlight">Trip Details Table</a></li></ul></li><li><a href="#cache-schema" class="table-of-contents__link toc-highlight">Cache Schema</a><ul><li><a href="#location-truth-cache" class="table-of-contents__link toc-highlight">Location Truth Cache</a></li><li><a href="#driver-proximity-cache" class="table-of-contents__link toc-highlight">Driver proximity Cache</a></li></ul></li></ul></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#notification-service" class="table-of-contents__link toc-highlight">Notification Service</a><ul><li><a href="#trip-management-service" class="table-of-contents__link toc-highlight">Trip Management Service</a></li><li><a href="#ride-matching-service" class="table-of-contents__link toc-highlight">Ride Matching Service</a></li><li><a href="#location-service" class="table-of-contents__link toc-highlight">Location Service</a></li></ul></li></ul></li><li><a href="#workflow" class="table-of-contents__link toc-highlight">Workflow</a></li><li><a href="#high-level-architecture---deep-dive" class="table-of-contents__link toc-highlight">High Level Architecture - Deep Dive</a><ul><li><a href="#how-to-efficiently-look-up-nearby-drivers" class="table-of-contents__link toc-highlight">How to efficiently look up nearby drivers?</a></li><li><a href="#location-update" class="table-of-contents__link toc-highlight">Location update</a></li><li><a href="#trip-recoding" class="table-of-contents__link toc-highlight">Trip recoding</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/interview/assets/js/runtime~main.245c4bb3.js"></script>
<script src="/interview/assets/js/main.4520b17d.js"></script>
</body>
</html>