<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-system-design/instagram">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-203163469-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-203163469-1",{anonymize_ip:!0})</script>


<link rel="manifest" href="/interview/manifest.json">
<meta name="theme-color" content="#1877F2">

<script src="https://kit.fontawesome.com/307bcbc229.js"></script>
<script src="https://unpkg.com/driver.js/dist/driver.min.js"></script>
<script src="https://unpkg.com/driver.js/dist/driver.min.css"></script>
<script src="/static/scrolltotop.js"></script><title data-rh="true">Instagram System Design • Interview Preparation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" name="twitter:image" content="https://shyamzzp.github.io/interview/interview/img/shyamzzp-logo.png"><meta data-rh="true" property="og:url" content="https://shyamzzp.github.io/interview/interview/docs/system-design/instagram"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="theme-color" content="#1877F2"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Instagram System Design • Interview Preparation"><meta data-rh="true" name="description" content="System Design for Instagram."><meta data-rh="true" property="og:description" content="System Design for Instagram."><link data-rh="true" rel="icon" href="/interview/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shyamzzp.github.io/interview/interview/docs/system-design/instagram"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/instagram" hreflang="en"><link data-rh="true" rel="alternate" href="https://shyamzzp.github.io/interview/interview/docs/system-design/instagram" hreflang="x-default"><link rel="stylesheet" href="/interview/assets/css/styles.e23aed3b.css">
<link rel="preload" href="/interview/assets/js/runtime~main.32b4d1e3.js" as="script">
<link rel="preload" href="/interview/assets/js/main.905acc22.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/interview/"><b class="navbar__title text--truncate">📖 Inteview Preparation</b></a><a class="navbar__item navbar__link" href="/interview/docs/design-patterns">Design Patterns 🚧</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Data Structures</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/arrays">Arrays</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/bit-manipulation">Bit Manipulation</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/comparators">Comparators</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/complexity">Complexity</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dequeue">Deque</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/dfs">DFS</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/graph">Graph</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/linked-list">Linked List</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/map">Map</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/math">Math</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/priority-queue">Priority Queue</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/snippets">Snippets</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/tree">Tree</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/trie">Trie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Algorithms</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/data-structures/algorithms">Common Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/common-problems">Common Problems</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/search-algorithms">Search Algorithms</a></li><li><a class="dropdown__link" href="/interview/docs/data-structures/sorting-algorithms">Sorting Algorithms</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">System Design</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/interview/docs/system-design/glossary">System Design Glossary</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li><a class="dropdown__link" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/interview/docs/system-design/instagram" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/shyamzzp/interview" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub Repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/interview/"><b>📖 Inteview Preparation</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/data-structures">Data Structures</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data Structures&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/interview/docs/design-patterns">Design Patterns</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/oops">OOPS Concepts</a><button aria-label="Toggle the collapsible sidebar category &#x27;OOPS Concepts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/interview/docs/questions">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/interview/docs/system-design">System Design</a><button aria-label="Toggle the collapsible sidebar category &#x27;System Design&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/glossary">System Design Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/interview/docs/system-design/instagram">Instagram System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/job-scheduling-system">Job Scheduling System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/netflix">Netflix System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/pastebin">Pastebin System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/tinyurl">Tinyurl System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/top-10-system-design">Top 10 System Design Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/twitter-system-design">Twitter System Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/interview/docs/system-design/uber">Uber/Lyft System Design</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/interview/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/interview/docs/system-design"><span itemprop="name">System Design</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Instagram System Design</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Instagram System Design</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="introduction-to-the-system">Introduction to the System<a class="hash-link" href="#introduction-to-the-system" title="Direct link to heading">​</a></h2><p>Let&#x27;s design a photo-sharing service like Instagram, where users can upload photos to share them with other users.
Similar Services: Flickr, Picasa.</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-what-is-instagram">1. What is Instagram?<a class="hash-link" href="#1-what-is-instagram" title="Direct link to heading">​</a></h3><p>Instagram is a social networking service that enables its users to upload and share their photos and videos with other users.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-requirements-and-goals-of-the-system">2. Requirements and Goals of the System<a class="hash-link" href="#2-requirements-and-goals-of-the-system" title="Direct link to heading">​</a></h3><p>Will be focusing on the functional and non-functional requirements of the system. Also we can define what actual features from the actual instagram are not in scope to minimize the effort.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-some-design-considerations">3. Some Design Considerations<a class="hash-link" href="#3-some-design-considerations" title="Direct link to heading">​</a></h3><p>What would be the feasible features and constraints of the system? Some of the consideration that we can think of that makes the system feasible to design in the given time period.</p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-capacity-estimation-and-constraints">4. Capacity Estimation and Constraints<a class="hash-link" href="#4-capacity-estimation-and-constraints" title="Direct link to heading">​</a></h3><p>Discussion about the traffic and storage that the system would be using. This will also be categorized on the basis of different timelines. For e.g. what is the overall space needed for the system to be up and running for 10 years.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-high-level-system-design">5. High Level System Design<a class="hash-link" href="#5-high-level-system-design" title="Direct link to heading">​</a></h3><p>Discussion about the high level design of instagram system. What are the services involved in the system and interaction between them along with the relationship with the db.</p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-database-schema">6. Database Schema<a class="hash-link" href="#6-database-schema" title="Direct link to heading">​</a></h3><p>What are the tables that are needed in the system? What are the columns in each table? What are the constraints on the columns? Which db to choose for the given system design?</p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-data-size-estimation">7. Data Size Estimation<a class="hash-link" href="#7-data-size-estimation" title="Direct link to heading">​</a></h3><p>This section will be specifically focused on, What is the data size of the db? What is the data size of the images? What is the data size of the videos? What is the size of the user that will be stored in the db, how many users can we support in the system?</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8-component-design">8. Component Design<a class="hash-link" href="#8-component-design" title="Direct link to heading">​</a></h3><p>Considering each component of the system, what are the services that are involved and how are they related to each other? What are the dependencies between the services? What are the dependencies between the services and the db? </p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9-reliability-and-redundancy">9. Reliability and Redundancy<a class="hash-link" href="#9-reliability-and-redundancy" title="Direct link to heading">​</a></h3><p>Discussing whether the system is reliable or not meaning if I upload anything to the system and if it is lost or not. What are the ways to make the system reliable? Discussion related to what if one of the server fails then will the whole system collapse?</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10-data-sharding">10. Data Sharding<a class="hash-link" href="#10-data-sharding" title="Direct link to heading">​</a></h3><p>Creating backup of the database and partitioning the database so that the data is not lost if one of the server fails. This also helps in the faster retrieval of the data and hence reducing the overall latency of the system. </p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-ranking-and-news-feed-generation">11. Ranking and News Feed Generation<a class="hash-link" href="#11-ranking-and-news-feed-generation" title="Direct link to heading">​</a></h3><p>How the home page of the application will be behaving and what are the initial assumptions and methods that are taken in consideration for the same. What are the different approaches that are taken to generate the news feed?</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-news-feed-creation-with-sharded-data">12. News Feed Creation with Sharded Data<a class="hash-link" href="#12-news-feed-creation-with-sharded-data" title="Direct link to heading">​</a></h3><p>As we are dealing with the distributed system hwo will the main feature of the system will be behaving with the database and how will the system be interacting with the database. The process includes fetching of the latest photos uploaded from the people who are following the user.</p></div><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-cache-and-load-balancing">13. Cache and Load balancing<a class="hash-link" href="#13-cache-and-load-balancing" title="Direct link to heading">​</a></h3><p>Our service would need a massive-scale photo delivery system to serve globally distributed users. Our service should push its content closer to the user using a large number of geographically distributed photo cache servers and use CDNs.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-what-powers-instagram---blog-post-from-instagram">14. What Powers Instagram - Blog Post from Instagram<a class="hash-link" href="#14-what-powers-instagram---blog-post-from-instagram" title="Direct link to heading">​</a></h3><p>One of the questions we always get asked at meet-ups and conversations with other engineers is, &quot;what&#x27;s your stack?&quot; We thought it would be fun to give a sense of all the systems that power Instagram, at a high-level; you can look forward to more in-depth descriptions of some of these systems in the future.</p></div></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-what-is-instagram-1">1. What is Instagram?<a class="hash-link" href="#1-what-is-instagram-1" title="Direct link to heading">​</a></h2><p>Instagram is a social networking service that enables its users to upload and share their photos and videos with other users. Instagram users can choose to share information either publicly or privately. Anything shared publicly can be seen by any other user, whereas privately shared content can only be accessed by the specified set of people. Instagram also enables its users to share through many other social networking platforms, such as Facebook, Twitter, Flickr, and Tumblr.</p><p>We plan to design a simpler version of Instagram for this design problem, where a user can share photos and follow other users. The &#x27;News Feed&#x27; for each user will consist of top photos of all the people the user follows.</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-requirements-and-goals-of-the-system-1">2. Requirements and Goals of the System<a class="hash-link" href="#2-requirements-and-goals-of-the-system-1" title="Direct link to heading">​</a></h2><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="functional-requirements">Functional Requirements<a class="hash-link" href="#functional-requirements" title="Direct link to heading">​</a></h3><ul><li>Users should be able to upload/download/view photos.</li><li>Users can perform searches based on photo/video titles.</li><li>Users can follow other users.</li><li>The system should generate and display a user&#x27;s News Feed consisting of top photos from all the people the user follows.</li></ul></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="non-functional-requirements">Non-Functional Requirements<a class="hash-link" href="#non-functional-requirements" title="Direct link to heading">​</a></h3><ul><li>Our service needs to be highly available.</li><li>The acceptable latency of the system is 200ms for News Feed generation.</li><li>Consistency can take a hit (in the interest of availability) if a user doesn&#x27;t see a photo for a while; it should be fine.</li><li>The system should be highly reliable; any uploaded photo or video should never be lost.</li></ul></div><strong>Not in scope: </strong> Adding tags to photos, searching photos on tags, commenting on photos, tagging users to photos, who to follow, etc.</div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-some-design-consideration">3. Some Design Consideration<a class="hash-link" href="#3-some-design-consideration" title="Direct link to heading">​</a></h2><p>The system would be read-heavy, so we will focus on building a system that can retrieve photos quickly.</p><ul><li>Practically, users can upload as many photos as they like; therefore, efficient management of storage should be a crucial factor in designing this system.</li><li>Low latency is expected while viewing photos.</li><li>Data should be 100% reliable. If a user uploads a photo, the system will guarantee that it will never be lost.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-capacity-estimation-and-constraints-1">4. Capacity Estimation and Constraints<a class="hash-link" href="#4-capacity-estimation-and-constraints-1" title="Direct link to heading">​</a></h2><ul><li>Let&#x27;s assume we have <strong>500M total users</strong>, with <mark>1M daily active users</mark>.</li><li>2M new photos every day, 23 new photos every second.</li><li>Average photo file size =&gt; <mark>200KB</mark></li><li>Total space required for 1 day of photos <mark>2M <!-- -->*<!-- --> 200KB =&gt; 400 GB</mark></li><li>Total space required for 10 years: <mark>400GB <em> 365 (days a year) </em> 10 (years) ~= 1425TB</mark></li></ul><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-high-level-system-design-1">5. High Level System Design<a class="hash-link" href="#5-high-level-system-design-1" title="Direct link to heading">​</a></h2><p>At a high-level, we need to support two scenarios, one to upload photos and the other to view/search photos. Our service would need some object storage servers to store photos and some database servers to store metadata information about the photos.</p><p><img loading="lazy" alt="High Level System Design BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-01-32-05-7e4fb0808da1944b1d8536641d2fb3ce.png" width="522" height="288" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6-database-schema-1">6. Database Schema<a class="hash-link" href="#6-database-schema-1" title="Direct link to heading">​</a></h2><p>We need to store data about users, their uploaded photos, and the people they follow. The Photo table will store all data related to a photo; we need to have an index on (PhotoID, CreationDate) since we need to fetch recent photos first.</p><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="table-photo">Table: Photo<a class="hash-link" href="#table-photo" title="Direct link to heading">​</a></h3><table><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody><tr><td>PhotoID</td><td>INT</td></tr><tr><td>UserID</td><td>INT</td></tr><tr><td>PhotoURL</td><td>VARCHAR(255)</td></tr><tr><td>PhotoLatitude</td><td>DOUBLE</td></tr><tr><td>PhotoLongitude</td><td>DOUBLE</td></tr><tr><td>UserLatitude</td><td>DOUBLE</td></tr><tr><td>UserLongitude</td><td>DOUBLE</td></tr><tr><td>CreationDate</td><td>DATETIME</td></tr></tbody></table></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="table-user">Table: User<a class="hash-link" href="#table-user" title="Direct link to heading">​</a></h4><table><thead><tr><th>Column</th><th>Type</th></tr></thead><tbody><tr><td>UserID</td><td>INT</td></tr><tr><td>UserName</td><td>VARCHAR(255)</td></tr><tr><td>UserPassword</td><td>VARCHAR(255)</td></tr><tr><td>UserLatitude</td><td>DOUBLE</td></tr><tr><td>UserLongitude</td><td>DOUBLE</td></tr><tr><td>UserCreationDate</td><td>DATETIME</td></tr><tr><td>UserLastLoginDate</td><td>DATETIME</td></tr></tbody></table></div></div><div class="section-container">We can store photos in a distributed file storage like HDFS or S3.<p>We can store the above schema in a distributed key-value store to enjoy the benefits offered by NoSQL. All the metadata related to photos can go to a table where the &#x27;key&#x27; would be the &#x27;PhotoID&#x27; and the &#x27;value&#x27; would be an object containing PhotoLocation, UserLocation, CreationTimestamp, etc.</p><p>NoSQL stores, in general, always maintain a certain number of replicas to offer reliability. Also, in such data stores, deletes don&#x27;t get applied instantly; data is retained for certain days (to support undeleting) before getting removed from the system permanently.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="why-choose-nosql">Why choose NoSQL?<a class="hash-link" href="#why-choose-nosql" title="Direct link to heading">​</a></h3><p>NoSql makes more sense to me because there are billions of videos on youtube and scaling relational database is hard (vertical scaling) and it will reach its limitation. </p><p>Whereas NoSql database like Cassandra are specifically designed with Big Data in mind and they are easily scalable. We need to come up with the right schema for tables so that queries which we run on Cassandra are efficient. Cassandra is write optimized not read.</p><p>For example Here for storing Metadata and user information we should answer this question:</p><ul><li>Schema Might change in future a lot ? - ✅ (NoSQL) | ❌ (SQL)</li><li>Do we care about the constituency about the likes and dislikes? - ✅ (SQL) | ❌ (NoSQL)</li><li>Do we have lot of relations in our DB: ✅ (SQL) | ❌ (NoSQL)</li><li>Are we going to do lots of Joins operation on data : ✅ (SQL) | ❌ (NoSQL)</li></ul></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7-data-size-estimation-1">7. Data Size Estimation<a class="hash-link" href="#7-data-size-estimation-1" title="Direct link to heading">​</a></h2><div class="section-container pl0 pr0">Let&#x27;s estimate how much data will be going into each table and how much total storage we will need for 10 years.<div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="user-data-size-per-recordrow">User Data Size Per Record/Row<a class="hash-link" href="#user-data-size-per-recordrow" title="Direct link to heading">​</a></h3><p>Assuming each &quot;int&quot; and &quot;dateTime&quot; is four bytes, each row in the User&#x27;s table will be of 68 bytes:</p><p>UserID (4 bytes) + Name (20 bytes) + Email (32 bytes) + DateOfBirth (4 bytes) + CreationDate (4 bytes) + LastLogin (4 bytes) = <mark>68 bytes</mark>
If we have 500 million users, we will need 32GB of total storage.</p><mark>500 million \* 68 ~= 32GB</mark></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="photo-data-size-per-recordrow">Photo Data Size Per Record/Row<a class="hash-link" href="#photo-data-size-per-recordrow" title="Direct link to heading">​</a></h3><p>Each row in Photo&#x27;s table will be of 284 bytes:</p><p>PhotoID (4 bytes) + UserID (4 bytes) + PhotoPath (256 bytes) + PhotoLatitude (4 bytes) + PhotoLongitude(4 bytes) + UserLatitude (4 bytes) + UserLongitude (4 bytes) + CreationDate (4 bytes) = <mark>284 bytes</mark>
If 2M new photos get uploaded every day, we will need 0.5GB of storage for one day:</p><p>2M <!-- -->*<!-- --> 284 bytes ~= <mark>0.5GB per day</mark>
For 10 years we will need <mark>1.88TB of storage.</mark></p></div></div><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="userfollow-data-size-per-recordrow">UserFollow Data Size Per Record/Row<a class="hash-link" href="#userfollow-data-size-per-recordrow" title="Direct link to heading">​</a></h3></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="overalltotal-data-size-per-recordrow">Overall/Total Data Size Per Record/Row<a class="hash-link" href="#overalltotal-data-size-per-recordrow" title="Direct link to heading">​</a></h3><p>Total space required for all tables for 10 years will be 3.7TB:</p><mark>32GB + 1.88TB + 1.82TB ~= 3.7TB</mark></div></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8-component-design-1">8. Component Design<a class="hash-link" href="#8-component-design-1" title="Direct link to heading">​</a></h2><p>Photo uploads (or writes) can be slow as they have to go to the disk, whereas reads will be faster, especially if they are being served from cache.</p><p>Uploading users can consume all the available connections, as uploading is a slow process. This means that &#x27;reads&#x27; cannot be served if the system gets busy with all the &#x27;write&#x27; requests. We should keep in mind that web servers have a connection limit before designing our system. If we assume that a web server can have a maximum of 500 connections at any time, then it can&#x27;t have more than 500 concurrent uploads or reads. </p><p>To handle this bottleneck, we can split reads and writes into separate services. We will have dedicated servers for reads and different servers for writes to ensure that uploads don&#x27;t hog the system.</p><p>Separating photos&#x27; read and write requests will also allow us to scale and optimize each of these operations independently.</p><p><img loading="lazy" alt="Bottleneck Cases BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-12-06-21-5d76d92e52c255d7533b9f954783d933.png" width="594" height="319" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9-reliability-and-redundancy-1">9. Reliability and Redundancy<a class="hash-link" href="#9-reliability-and-redundancy-1" title="Direct link to heading">​</a></h2><p>Losing files is not an option for our service. Therefore, we will store multiple copies of each file so that if one storage server dies, we can retrieve the photo from the other copy present on a different storage server.</p><p>This same principle also applies to other components of the system. If we want to have high availability of the system, we need to have multiple replicas of services running in the system so that even if a few services die down, the system remains available and running. Redundancy removes the single point of failure in the system.</p><p>If only one instance of a service is required to run at any point, we can run a redundant secondary copy of the service that is not serving any traffic, but it can take control after the failover when the primary has a problem.</p><p>Creating redundancy in a system can remove single points of failure and provide a backup or spare functionality if needed in a crisis. For example, if there are two instances of the same service running in production and one fails or degrades, the system can failover to the healthy copy. Failover can happen automatically or require manual intervention.</p><p><img loading="lazy" alt="Reliability and Redundancy BorderRadius8 MarginTop10" src="/interview/assets/images/2022-06-25-12-08-38-ad43f4e1aac924f65ff3ce159d6f576c.png" width="722" height="340" class="img_ev3q"></p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10-data-sharding-1">10. Data Sharding<a class="hash-link" href="#10-data-sharding-1" title="Direct link to heading">​</a></h2><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="partitioning-based-on-userid">Partitioning based on UserID<a class="hash-link" href="#partitioning-based-on-userid" title="Direct link to heading">​</a></h3><p>Let&#x27;s assume we shard based on the &#x27;UserID&#x27; so that we can keep all photos of a user on the same shard. If one DB shard is 1TB, we will need four shards to store 3.7TB of data. Let&#x27;s assume, for better performance and scalability, we keep 10 shards.</p><p>So we&#x27;ll find the shard number by UserID % 10 and then store the data there. To uniquely identify any photo in our system, we can append the shard number with each PhotoID.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-can-we-generate-photoids">How can we generate PhotoIDs?<a class="hash-link" href="#how-can-we-generate-photoids" title="Direct link to heading">​</a></h3><p>Each DB shard can have its own auto-increment sequence for PhotoIDs, and since we will append ShardID with each PhotoID, it will make it unique throughout our system.</p></div></div><div class="section-container pl0 pr0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="what-are-the-different-issues-with-this-partitioning-scheme">What are the different issues with this partitioning scheme?<a class="hash-link" href="#what-are-the-different-issues-with-this-partitioning-scheme" title="Direct link to heading">​</a></h3><ol><li>How would we handle hot users? Several people follow such hot users, and a lot of other people see any photo they upload.</li><li>Some users will have a lot of photos compared to others, thus making a non-uniform distribution of storage.</li><li>What if we cannot store all pictures of a user on one shard? If we distribute photos of a user onto multiple shards, will it cause higher latencies?</li><li>Storing all photos of a user on one shard can cause issues like unavailability of all of the user&#x27;s data if that shard is down or higher latency if it is serving high load etc.</li></ol></div><hr><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="partitioning-based-on-photoid">Partitioning based on PhotoID<a class="hash-link" href="#partitioning-based-on-photoid" title="Direct link to heading">​</a></h3><p>If we can generate unique PhotoIDs first and then find a shard number through “PhotoID % 10”, the above problems will have been solved. We would not need to append ShardID with PhotoID in this case, as PhotoID will itself be unique throughout the system.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-can-we-generate-photoids-1">How can we generate PhotoIDs?<a class="hash-link" href="#how-can-we-generate-photoids-1" title="Direct link to heading">​</a></h3><p>Here, we cannot have an auto-incrementing sequence in each shard to define PhotoID because we need to know PhotoID first to find the shard where it will be stored. One solution could be that we dedicate a separate database instance to generate auto-incrementing IDs. If our PhotoID can fit into 64 bits, we can define a table containing only a 64 bit ID field. </p><p>So whenever we would like to add a photo in our system, we can insert a new row in this table and take that ID to be our PhotoID of the new photo.</p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="wouldnt-this-key-generating-db-be-a-single-point-of-failure">Wouldn&#x27;t this key generating DB be a single point of failure?<a class="hash-link" href="#wouldnt-this-key-generating-db-be-a-single-point-of-failure" title="Direct link to heading">​</a></h3><p>Yes, it would be. A workaround for that could be to define two such databases, one generating even-numbered IDs and the other odd-numbered.
We can put a load balancer in front of both of these databases to round-robin between them and to deal with downtime. Both these servers could be out of sync, with one generating more keys than the other, but this will not cause any issue in our system. </p><p>We can extend this design by defining separate ID tables for Users, Photo-Comments, or other objects present in our system.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-can-we-plan-for-the-future-growth-of-our-system">How can we plan for the future growth of our system?<a class="hash-link" href="#how-can-we-plan-for-the-future-growth-of-our-system" title="Direct link to heading">​</a></h3><p>We can have a large number of logical partitions to accommodate future data growth, such that in the beginning, multiple logical partitions reside on a single physical database server. Since each database server can have multiple database instances running on it, we can have separate databases for each logical partition on any server. </p><p>So whenever we feel that a particular database server has a lot of data, we can migrate some logical partitions from it to another server. We can maintain a config file (or a separate database) that can map our logical partitions to database servers; this will enable us to move partitions around easily. Whenever we want to move a partition, we only have to update the config file to announce the change.</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11-ranking-and-news-feed-generation-1">11. Ranking and News Feed Generation<a class="hash-link" href="#11-ranking-and-news-feed-generation-1" title="Direct link to heading">​</a></h2><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="workflow-for-ranking">Workflow for Ranking<a class="hash-link" href="#workflow-for-ranking" title="Direct link to heading">​</a></h3><p>To create the News Feed for any given user, we need to fetch the latest, most popular, and relevant photos of the people the user follows.</p><p>For simplicity, let&#x27;s assume we need to fetch the top 100 photos for a user&#x27;s News Feed. Our application server will first get a list of people the user follows and then fetch metadata info of each user&#x27;s latest 100 photos. In the final step, the server will submit all these photos to our ranking algorithm, which will determine the top 100 photos (based on recency, likeness, etc.) and return them to the user. </p></div><div class="section-container pl0 pr0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pre-generating-the-news-feed">Pre-generating the News Feed<a class="hash-link" href="#pre-generating-the-news-feed" title="Direct link to heading">​</a></h3><p>A possible problem with this approach would be higher latency as we have to query multiple tables and perform sorting/merging/ranking on the results. To improve the efficiency, we can pre-generate the News Feed and store it in a separate table.</p><p>We can have dedicated servers that are continuously generating users&#x27; News Feeds and storing them in a ‘UserNewsFeed&#x27; table. So whenever any user needs the latest photos for their News-Feed, we will simply query this table and return the results to the user.</p><p>Whenever these servers need to generate the News Feed of a user, they will first query the UserNewsFeed table to find the last time the News Feed was generated for that user. Then, new News-Feed data will be generated from that time onwards (following the steps mentioned above).</p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="what-are-the-different-approaches-for-sending-news-feed-contents-to-the-users">What are the different approaches for sending News Feed contents to the users?<a class="hash-link" href="#what-are-the-different-approaches-for-sending-news-feed-contents-to-the-users" title="Direct link to heading">​</a></h3><div class="section-container pl0 pr0"><div class="section-item pl0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-pull">1. Pull:<a class="hash-link" href="#1-pull" title="Direct link to heading">​</a></h4><p>Clients can pull the News-Feed contents from the server at a regular interval or manually whenever they need it. Possible problems with this approach are a) New data might not be shown to the users until clients issue a pull request b) Most of the time, pull requests will result in an empty response if there is no new data.</p></div><div class="section-item"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-push">2. Push:<a class="hash-link" href="#2-push" title="Direct link to heading">​</a></h4><p>Servers can push new data to the users as soon as it is available. To efficiently manage this, users have to maintain a Long Poll request with the server for receiving the updates. A possible problem with this approach is a user who follows a lot of people or a celebrity user who has millions of followers; in this case, the server has to push updates quite frequently.</p></div></div><div class="section-container pl0 pr0"><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-hybrid">3. Hybrid:<a class="hash-link" href="#3-hybrid" title="Direct link to heading">​</a></h4><p>We can adopt a hybrid approach. We can move all the users who have a high number of followers to a pull-based model and only push data to those who have a few hundred (or thousand) follows. Another approach could be that the server pushes updates to all the users not more than a certain frequency and letting users with a lot of updates to pull data regularly.</p></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="12-news-feed-creation-with-sharded-data-1">12. News Feed Creation with Sharded Data<a class="hash-link" href="#12-news-feed-creation-with-sharded-data-1" title="Direct link to heading">​</a></h2><p>One of the most important requirements to create the News Feed for any given user is to fetch the latest photos from all people the user follows. For this, we need to have a mechanism to sort photos on their time of creation. To efficiently do this, we can make photo creation time part of the PhotoID. As we will have a primary index on PhotoID, it will be quite quick to find the latest PhotoIDs.</p><p>We can use epoch time for this. Let&#x27;s say our PhotoID will have two parts; the first part will be representing epoch time, and the second part will be an auto-incrementing sequence. So to make a new PhotoID, we can take the current epoch time and append an auto-incrementing ID from our key-generating DB. We can figure out the shard number from this PhotoID ( PhotoID % 10) and store the photo there.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="what-could-be-the-size-of-our-photoid">What could be the size of our PhotoID?<a class="hash-link" href="#what-could-be-the-size-of-our-photoid" title="Direct link to heading">​</a></h3><p>Let&#x27;s say our epoch time starts today; how many bits we would need to store the number of seconds for the next 50 years?</p><mark>86400 sec/day _ 365 (days a year) _ 50 (years) =&gt; 1.6 billion seconds</mark><p>We would need 31 bits to store this number. Since, on average, we are expecting 23 new photos per second, we can allocate 9 additional bits to store the auto-incremented sequence. So every second, we can store (2^9 =&gt; 512)
(2^9=&gt;512) new photos. We are allocating 9 bits for the sequence number which is more than what we require; we are doing this to get a full byte number (as 40 bits = 5 bytes). We can reset our auto-incrementing sequence every second.</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="13-cache-and-load-balancing-1">13. Cache and Load balancing<a class="hash-link" href="#13-cache-and-load-balancing-1" title="Direct link to heading">​</a></h2><p>Our service would need a massive-scale photo delivery system to serve globally distributed users. Our service should push its content closer to the user using a large number of geographically distributed photo cache servers and use CDNs.</p><p>We can introduce a cache for metadata servers to cache hot database rows. We can use Memcache to cache the data, and Application servers before hitting the database can quickly check if the cache has desired rows. Least Recently Used (LRU) can be a reasonable cache eviction policy for our system. Under this policy, we discard the least recently viewed row first.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-can-we-build-a-more-intelligent-cache">How can we build a more intelligent cache?<a class="hash-link" href="#how-can-we-build-a-more-intelligent-cache" title="Direct link to heading">​</a></h3><p>If we go with the eighty-twenty rule, i.e., 20% of daily read volume for photos is generating 80% of the traffic, which means that certain photos are so popular that most people read them. This dictates that we can try caching 20% of the daily read volume of photos and metadata.</p><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="14-what-powers-instagram-optional">14. What Powers Instagram (Optional)<a class="hash-link" href="#14-what-powers-instagram-optional" title="Direct link to heading">​</a></h2><p>One of the questions we always get asked at meet-ups and conversations with other engineers is, “what&#x27;s your stack?” We thought it would be fun to give a sense of all the systems that power Instagram, at a high-level; you can look forward to more in-depth descriptions of some of these systems in the future. </p><p>This is how our system has evolved in the just-over-1-year that we&#x27;ve been live, and while there are parts we&#x27;re always re-working, this is a glimpse of how a startup with a small engineering team can scale to our 14 million+ users in a little over a year. Our core principles when choosing a system are:</p><ul><li>Keep it very simple</li><li>Don&#x27;t re-invent the wheel</li><li>Go with proven and solid technologies when you can</li></ul><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="os--hosting">OS / Hosting<a class="hash-link" href="#os--hosting" title="Direct link to heading">​</a></h3><p>We run Ubuntu Linux 11.04 (“Natty Narwhal”) on Amazon EC2. We&#x27;ve found previous versions of Ubuntu had all sorts of unpredictable freezing episodes on EC2 under high traffic, but Natty has been solid. </p><p>We&#x27;ve only got 3 engineers, and our needs are still evolving, so self-hosting isn&#x27;t an option we&#x27;ve explored too deeply yet, though is something we may revisit in the future given the unparalleled growth in usage.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="load-balancing">Load Balancing<a class="hash-link" href="#load-balancing" title="Direct link to heading">​</a></h3><p>Every request to Instagram servers goes through load balancing machines; we used to run 2 nginx machines and DNS Round-Robin between them. The downside of this approach is the time it takes for DNS to update in case one of the machines needs to get decomissioned. </p><p>Recently, we moved to using Amazon&#x27;s Elastic Load Balancer, with 3 NGINX instances behind it that can be swapped in and out (and are automatically taken out of rotation if they fail a health check). We also terminate our SSL at the ELB level, which lessens the CPU load on nginx. We use Amazon&#x27;s Route53 for DNS, which they&#x27;ve recently added a pretty good GUI tool for in the AWS console.</p></div></div><div class="section-container pl0 pr0"><div class="section-item pl0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="application-servers">Application Servers<a class="hash-link" href="#application-servers" title="Direct link to heading">​</a></h3><p>Next up comes the application servers that handle our requests. We run Django on Amazon High-CPU Extra-Large machines, and as our usage grows we&#x27;ve gone from just a few of these machines to over 25 of them (luckily, this is one area that&#x27;s easy to horizontally scale as they are stateless). </p><p>We&#x27;ve found that our particular work-load is very CPU-bound rather than memory-bound, so the High-CPU Extra-Large instance type provides the right balance of memory and CPU.</p><p>We use <a href="http://gunicorn.org/" target="_blank" rel="noopener noreferrer">http://gunicorn.org/</a> as our WSGI server; we used to use mod_wsgi and Apache, but found Gunicorn was much easier to configure, and less CPU-intensive. To run commands on many instances at once (like deploying code), we use Fabric, which recently added a useful parallel mode so that deploys take a matter of seconds.</p></div><div class="section-item"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="task-queue--push-notifications">Task Queue &amp; Push Notifications<a class="hash-link" href="#task-queue--push-notifications" title="Direct link to heading">​</a></h3><p>When a user decides to share out an Instagram photo to Twitter or Facebook, or when we need to notify one of our Real-time subscribers of a new photo posted, we push that task into Gearman, a task queue system originally written at Danga.</p><p>Doing it asynchronously through the task queue means that media uploads can finish quickly, while the ‘heavy lifting&#x27; can run in the background. We have about 200 workers (all written in Python) consuming the task queue at any given time, split between the services we share to. We also do our feed fan-out in Gearman, so posting is as responsive for a new user as it is for a user with many followers.</p><p>For doing push notifications, the most cost-effective solution we found was github.com/samuraisam/pyapns, an open-source Twisted service that has handled over a billion push notifications for us, and has been rock-solid.</p></div></div><div class="section-container pl0 pr0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="data-storage">Data storage<a class="hash-link" href="#data-storage" title="Direct link to heading">​</a></h3><p>Most of our data (users, photo metadata, tags, etc) lives in PostgreSQL; we&#x27;ve previously written about how we shard across our different Postgres instances. Our main shard cluster involves 12 Quadruple Extra-Large memory instances (and twelve replicas in a different zone.)</p><p>We&#x27;ve found that Amazon&#x27;s network disk system (EBS) doesn&#x27;t support enough disk seeks per second, so having all of our working set in memory is extremely important. To get reasonable IO performance, we set up our EBS drives in a software RAID using mdadm.</p><p>As a quick tip, we&#x27;ve found that vmtouch is a fantastic tool for managing what data is in memory, especially when failing over from one machine to another where there is no active memory profile already.</p><p>All of our PostgreSQL instances run in a master-replica setup using Streaming Replication, and we use EBS snap-shotting to take frequent backups of our systems. We use XFS as our file system, which lets us freeze &amp; unfreeze the RAID arrays when snap-shotting, in order to guarantee a consistent snapshot (our original inspiration came from ec2-consistent-snapshot. To get streaming replication started, our favorite tool is repmgr by the folks at 2ndQuadrant.</p><p>To connect to our databases from our app servers, we made early on that had a huge impact on performance was using Pgbouncer to pool our connections to PostgreSQL. We found Christophe Pettus&#x27;s blog to be a great resource for Django, PostgreSQL and Pgbouncer tips.</p><p>The photos themselves go straight to Amazon S3, which currently stores several terabytes of photo data for us. We use Amazon CloudFront as our CDN, which helps with image load times from users around the world (like in Japan, our second most-popular country).</p><p>We also use Redis extensively; it powers our main feed, our activity feed, our sessions system (here&#x27;s our Django session backend), and other related systems. All of Redis&#x27; data needs to fit in memory, so we end up running several Quadruple Extra-Large Memory instances for Redis, too, and occasionally shard across a few Redis instances for any given subsystem. </p><p>We run Redis in a master-replica setup, and have the replicas constantly saving the DB out to disk, and finally use EBS snapshots to backup those DB dumps (we found that dumping the DB on the master was too taxing). Since Redis allows writes to its replicas, it makes for very easy online failover to a new Redis machine, without requiring any downtime.</p><p>We run Redis in a master-replica setup, and have the replicas constantly saving the DB out to disk, and finally use EBS snapshots to backup those DB dumps (we found that dumping the DB on the master was too taxing). Since Redis allows writes to its replicas, it makes for very easy online failover to a new Redis machine, without requiring any downtime.</p></div><div class="section-container pl0 pr0"><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="monitoring">Monitoring<a class="hash-link" href="#monitoring" title="Direct link to heading">​</a></h3><p>With 100+ instances, it&#x27;s important to keep on top of what&#x27;s going on across the board. We use Munin to graph metrics across all of our system, and also alert us if anything is outside of its normal range. We write a lot of custom Munin plugins, building on top of Python-Munin, to graph metrics that aren&#x27;t system-level (for example, sign-ups per minute, photos posted per second, etc). </p><p>We use Pingdom for external monitoring of the service, and PagerDuty for handling notifications and incidents.</p><p>For Python error reporting, we use Sentry, an awesome open-source Django app written by the folks at Disqus. At any given time, we can sign-on and see what errors are happening across our system, in real time.</p></div><hr><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="references">References<a class="hash-link" href="#references" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.educative.io/courses/grokking-the-system-design-interview/m2yDVZnQ8lG" target="_blank" rel="noopener noreferrer">https://www.educative.io/courses/grokking-the-system-design-interview/m2yDVZnQ8lG</a></li><li><a href="https://instagram-engineering.com/what-powers-instagram-hundreds-of-instances-dozens-of-technologies-adf2e22da2ad" target="_blank" rel="noopener noreferrer">https://instagram-engineering.com/what-powers-instagram-hundreds-of-instances-dozens-of-technologies-adf2e22da2ad</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/interview/docs/system-design/glossary"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">System Design Glossary</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/interview/docs/system-design/job-scheduling-system"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Job Scheduling System</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-to-the-system" class="table-of-contents__link toc-highlight">Introduction to the System</a><ul><li><a href="#1-what-is-instagram" class="table-of-contents__link toc-highlight">1. What is Instagram?</a></li><li><a href="#2-requirements-and-goals-of-the-system" class="table-of-contents__link toc-highlight">2. Requirements and Goals of the System</a></li><li><a href="#3-some-design-considerations" class="table-of-contents__link toc-highlight">3. Some Design Considerations</a></li><li><a href="#4-capacity-estimation-and-constraints" class="table-of-contents__link toc-highlight">4. Capacity Estimation and Constraints</a></li><li><a href="#5-high-level-system-design" class="table-of-contents__link toc-highlight">5. High Level System Design</a></li><li><a href="#6-database-schema" class="table-of-contents__link toc-highlight">6. Database Schema</a></li><li><a href="#7-data-size-estimation" class="table-of-contents__link toc-highlight">7. Data Size Estimation</a></li><li><a href="#8-component-design" class="table-of-contents__link toc-highlight">8. Component Design</a></li><li><a href="#9-reliability-and-redundancy" class="table-of-contents__link toc-highlight">9. Reliability and Redundancy</a></li><li><a href="#10-data-sharding" class="table-of-contents__link toc-highlight">10. Data Sharding</a></li><li><a href="#11-ranking-and-news-feed-generation" class="table-of-contents__link toc-highlight">11. Ranking and News Feed Generation</a></li><li><a href="#12-news-feed-creation-with-sharded-data" class="table-of-contents__link toc-highlight">12. News Feed Creation with Sharded Data</a></li><li><a href="#13-cache-and-load-balancing" class="table-of-contents__link toc-highlight">13. Cache and Load balancing</a></li><li><a href="#14-what-powers-instagram---blog-post-from-instagram" class="table-of-contents__link toc-highlight">14. What Powers Instagram - Blog Post from Instagram</a></li></ul></li><li><a href="#1-what-is-instagram-1" class="table-of-contents__link toc-highlight">1. What is Instagram?</a></li><li><a href="#2-requirements-and-goals-of-the-system-1" class="table-of-contents__link toc-highlight">2. Requirements and Goals of the System</a><ul><li><a href="#functional-requirements" class="table-of-contents__link toc-highlight">Functional Requirements</a></li><li><a href="#non-functional-requirements" class="table-of-contents__link toc-highlight">Non-Functional Requirements</a></li></ul></li><li><a href="#3-some-design-consideration" class="table-of-contents__link toc-highlight">3. Some Design Consideration</a></li><li><a href="#4-capacity-estimation-and-constraints-1" class="table-of-contents__link toc-highlight">4. Capacity Estimation and Constraints</a></li><li><a href="#5-high-level-system-design-1" class="table-of-contents__link toc-highlight">5. High Level System Design</a></li><li><a href="#6-database-schema-1" class="table-of-contents__link toc-highlight">6. Database Schema</a><ul><li><a href="#table-photo" class="table-of-contents__link toc-highlight">Table: Photo</a><ul><li><a href="#table-user" class="table-of-contents__link toc-highlight">Table: User</a></li></ul></li><li><a href="#why-choose-nosql" class="table-of-contents__link toc-highlight">Why choose NoSQL?</a></li></ul></li><li><a href="#7-data-size-estimation-1" class="table-of-contents__link toc-highlight">7. Data Size Estimation</a><ul><li><a href="#user-data-size-per-recordrow" class="table-of-contents__link toc-highlight">User Data Size Per Record/Row</a></li><li><a href="#photo-data-size-per-recordrow" class="table-of-contents__link toc-highlight">Photo Data Size Per Record/Row</a></li><li><a href="#userfollow-data-size-per-recordrow" class="table-of-contents__link toc-highlight">UserFollow Data Size Per Record/Row</a></li><li><a href="#overalltotal-data-size-per-recordrow" class="table-of-contents__link toc-highlight">Overall/Total Data Size Per Record/Row</a></li></ul></li><li><a href="#8-component-design-1" class="table-of-contents__link toc-highlight">8. Component Design</a></li><li><a href="#9-reliability-and-redundancy-1" class="table-of-contents__link toc-highlight">9. Reliability and Redundancy</a></li><li><a href="#10-data-sharding-1" class="table-of-contents__link toc-highlight">10. Data Sharding</a><ul><li><a href="#partitioning-based-on-userid" class="table-of-contents__link toc-highlight">Partitioning based on UserID</a></li><li><a href="#how-can-we-generate-photoids" class="table-of-contents__link toc-highlight">How can we generate PhotoIDs?</a></li><li><a href="#what-are-the-different-issues-with-this-partitioning-scheme" class="table-of-contents__link toc-highlight">What are the different issues with this partitioning scheme?</a></li><li><a href="#partitioning-based-on-photoid" class="table-of-contents__link toc-highlight">Partitioning based on PhotoID</a></li><li><a href="#how-can-we-generate-photoids-1" class="table-of-contents__link toc-highlight">How can we generate PhotoIDs?</a></li><li><a href="#wouldnt-this-key-generating-db-be-a-single-point-of-failure" class="table-of-contents__link toc-highlight">Wouldn&#39;t this key generating DB be a single point of failure?</a></li><li><a href="#how-can-we-plan-for-the-future-growth-of-our-system" class="table-of-contents__link toc-highlight">How can we plan for the future growth of our system?</a></li></ul></li><li><a href="#11-ranking-and-news-feed-generation-1" class="table-of-contents__link toc-highlight">11. Ranking and News Feed Generation</a><ul><li><a href="#workflow-for-ranking" class="table-of-contents__link toc-highlight">Workflow for Ranking</a></li><li><a href="#pre-generating-the-news-feed" class="table-of-contents__link toc-highlight">Pre-generating the News Feed</a></li><li><a href="#what-are-the-different-approaches-for-sending-news-feed-contents-to-the-users" class="table-of-contents__link toc-highlight">What are the different approaches for sending News Feed contents to the users?</a><ul><li><a href="#1-pull" class="table-of-contents__link toc-highlight">1. Pull:</a></li><li><a href="#2-push" class="table-of-contents__link toc-highlight">2. Push:</a></li><li><a href="#3-hybrid" class="table-of-contents__link toc-highlight">3. Hybrid:</a></li></ul></li></ul></li><li><a href="#12-news-feed-creation-with-sharded-data-1" class="table-of-contents__link toc-highlight">12. News Feed Creation with Sharded Data</a><ul><li><a href="#what-could-be-the-size-of-our-photoid" class="table-of-contents__link toc-highlight">What could be the size of our PhotoID?</a></li></ul></li><li><a href="#13-cache-and-load-balancing-1" class="table-of-contents__link toc-highlight">13. Cache and Load balancing</a><ul><li><a href="#how-can-we-build-a-more-intelligent-cache" class="table-of-contents__link toc-highlight">How can we build a more intelligent cache?</a></li></ul></li><li><a href="#14-what-powers-instagram-optional" class="table-of-contents__link toc-highlight">14. What Powers Instagram (Optional)</a><ul><li><a href="#os--hosting" class="table-of-contents__link toc-highlight">OS / Hosting</a></li><li><a href="#load-balancing" class="table-of-contents__link toc-highlight">Load Balancing</a></li><li><a href="#application-servers" class="table-of-contents__link toc-highlight">Application Servers</a></li><li><a href="#task-queue--push-notifications" class="table-of-contents__link toc-highlight">Task Queue &amp; Push Notifications</a></li><li><a href="#data-storage" class="table-of-contents__link toc-highlight">Data storage</a></li><li><a href="#monitoring" class="table-of-contents__link toc-highlight">Monitoring</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/interview/assets/js/runtime~main.32b4d1e3.js"></script>
<script src="/interview/assets/js/main.905acc22.js"></script>
</body>
</html>